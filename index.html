<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø¨Ø²Ø§Ø± ØªÙˆÙ„ÛŒØ¯ Ø¢Ø²Ù…ÙˆÙ†</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Vazirmatn for Persian UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for File Handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.4.18/mammoth.browser.min.js"></script>
    
    <!-- MathJax Configuration -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      }
    };
    </script>
    <!-- MathJax for LaTeX Rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .tab-button.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        mjx-container {
            direction: ltr;
            text-align: right;
            display: inline-block;
        }
        #results {
            line-height: 2.2;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #output-container, #output-container * {
                visibility: visible;
            }
            #output-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto !important; 
                overflow-y: visible !important;
                border: none;
            }
            .lg\:col-span-2 {
                visibility: visible !important;
            }
        }
        
        /* Dark mode styles */
        .dark {
            background-color: #1a202c;
            color: #edf2f7;
        }
        .dark .bg-slate-50 {
            background-color: #2d3748;
        }
        .dark .text-slate-800 {
            color: #edf2f7;
        }
        .dark .bg-white {
            background-color: #4a5568;
        }
        .dark .border-slate-200 {
            border-color: #718096;
        }
        .dark .border-slate-300 {
            border-color: #a0aec0;
        }
        .dark .text-slate-700 {
            color: #cbd5e0;
        }
        .dark .text-slate-500 {
            color: #a0aec0;
        }
        .dark .text-slate-400 {
            color: #718096;
        }
        .dark .bg-slate-100 {
            background-color: #718096;
        }
        .dark .hover\:bg-slate-200:hover {
            background-color: #a0aec0;
        }
        .dark input[type="text"], 
        .dark input[type="password"], 
        .dark textarea, 
        .dark select {
            background-color: #4a5568;
            color: #edf2f7;
            border-color: #718096;
        }
        .dark input[type="text"]:focus, 
        .dark input[type="password"]:focus, 
        .dark textarea:focus, 
        .dark select:focus {
            border-color: #3182ce;
            background-color: #4a5568;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex flex-col flex-1">
        <!-- Header -->
        <header class="text-center mb-8 flex-shrink-0 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">ğŸ“  ØªÙˆÙ„ÛŒØ¯ Ø¢Ø²Ù…ÙˆÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h1>
            <!-- Controls -->
            <div class="absolute top-0 right-0 flex items-center space-x-4 space-x-reverse">
                <!-- Language Toggle -->
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-sm text-slate-600">FA</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-language" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                    <span class="text-sm text-slate-600">EN</span>
                </div>
                <!-- Dark Mode Toggle -->
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-sm text-slate-600">ğŸŒ™</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-dark-mode" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm text-slate-600">â˜€ï¸</span>
                </div>
            </div>
        </header>

        <!-- API Key Input -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex-shrink-0">
            <div class="flex justify-between items-center mb-2">
                <label for="apiKey" class="block text-sm font-bold text-slate-700">ğŸ”‘ Ú©Ù„ÛŒØ¯ API Gemini</label>
                <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:underline font-medium">Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§</a>
            </div>
            <input type="password" id="apiKey" placeholder="Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" style="direction: ltr; text-align: right;">
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
            <!-- Left Column: Input & Controls -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Content Input Section -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-3 text-slate-800"> Ù…Ù†Ø¨Ø¹ Ø³ÙˆØ§Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</h2>
                    <!-- Tabs -->
                    <div class="flex border-b border-slate-200 mb-4">
                        <button id="text-tab-btn" class="tab-button active flex-1 py-2 px-4 text-sm border-b-2">Ù…ØªÙ†</button>
                        <button id="file-tab-btn" class="tab-button flex-1 py-2 px-4 text-sm border-b-2">ÙØ§ÛŒÙ„</button>
                    </div>
                    <!-- Tab Content -->
                    <div id="text-tab-content">
                        <textarea id="text-input" rows="10" class="w-full p-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-400" placeholder="Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­ Ø³ÙˆØ§Ù„ Ø§Ø² Ù…ØªÙ† Ø®Ø§ØµØŒ Ø¢Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                    </div>
                    <div id="file-tab-content" class="hidden">
                        <input type="file" id="file-input" accept=".pdf,.docx" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <p id="file-status" class="text-xs text-green-600 mt-2"></p>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="flex justify-center">
                    <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 shadow-md">
                        ğŸš€ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª
                    </button>
                </div>

                <!-- Control Panel -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 control-panel space-y-4">
                    <h2 class="text-lg font-bold mb-2 text-slate-800"> ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÙˆØ§Ù„Ø§Øª</h2>
                    
                    <!-- Subject and Grade Selection -->
                    <div>
                        <label for="subject" class="block text-sm font-medium mb-1">Ø¯Ø±Ø³</label>
                        <select id="subject" class="w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            <option value="Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ">Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</option>
                            <option value="Ø²ÛŒØ³Øª Ø´Ù†Ø§Ø³ÛŒ">Ø²ÛŒØ³Øª Ø´Ù†Ø§Ø³ÛŒ</option>
                            <option value="ÙÛŒØ²ÛŒÚ©">ÙÛŒØ²ÛŒÚ©</option>
                            <option value="Ø±ÛŒØ§Ø¶ÛŒ">Ø±ÛŒØ§Ø¶ÛŒ</option>
                            <option value="Ø´ÛŒÙ…ÛŒ">Ø´ÛŒÙ…ÛŒ</option>
                        </select>
                    </div>
                     <div>
                        <label for="grade" class="block text-sm font-medium mb-1">Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ</label>
                        <select id="grade" class="w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            <optgroup label="Ø¯ÙˆØ±Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">
                                <option value="Ù¾Ø§ÛŒÙ‡ Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø§ÙˆÙ„</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆÙ… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆÙ…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ø³ÙˆÙ… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø³ÙˆÙ…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ú†Ù‡Ø§Ø±Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ú†Ù‡Ø§Ø±Ù…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ù¾Ù†Ø¬Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ù¾Ù†Ø¬Ù…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ø´Ø´Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø´Ø´Ù…</option>
                            </optgroup>
                            <optgroup label="Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„">
                                <option value="Ù¾Ø§ÛŒÙ‡ Ù‡ÙØªÙ…">Ù¾Ø§ÛŒÙ‡ Ù‡ÙØªÙ…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ù‡Ø´ØªÙ…">Ù¾Ø§ÛŒÙ‡ Ù‡Ø´ØªÙ…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ù†Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ Ù†Ù‡Ù…</option>
                            </optgroup>
                            <optgroup label="Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…">
                                <option value="Ù¾Ø§ÛŒÙ‡ Ø¯Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ Ø¯Ù‡Ù…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ ÛŒØ§Ø²Ø¯Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ ÛŒØ§Ø²Ø¯Ù‡Ù…</option>
                                <option value="Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…</option>
                            </optgroup>
                             <optgroup label="Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡">
                                <option value="Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ">Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ</option>
                            </optgroup>
                        </select>
                    </div>

                    <hr class="my-4">

                    <div>
                        <label for="question-type" class="block text-sm font-medium mb-1">Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„</label>
                        <select id="question-type" class="w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø­Ø±Ø§ÙÛŒ Ù…Ù†Ø·Ù‚ÛŒ">Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</option>
                            <option value="ØµØ­ÛŒØ­/ØºÙ„Ø·">ØµØ­ÛŒØ­/ØºÙ„Ø·</option>
                            <option value="ØªØ´Ø±ÛŒØ­ÛŒ Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø®">ØªØ´Ø±ÛŒØ­ÛŒ (Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø®)</option>
                            <option value="ØªØ´Ø±ÛŒØ­ÛŒ Ø¨Ù„Ù†Ø¯ Ù¾Ø§Ø³Ø®">ØªØ´Ø±ÛŒØ­ÛŒ (Ø¨Ù„Ù†Ø¯ Ù¾Ø§Ø³Ø®)</option>
                            <option value="Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ">Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ</option>
                        </select>
                    </div>
                    <div>
                        <label for="difficulty" class="block text-sm font-medium mb-1">Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ</label>
                        <select id="difficulty" class="w-full p-2 border border-slate-300 rounded-md bg-white">
                            <option value="Ø¢Ø³Ø§Ù†">Ø¢Ø³Ø§Ù†</option>
                            <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ø³Ø®Øª">Ø³Ø®Øª</option>
                            <option value="Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ù„ÙˆÙ… (ØªÙ…Ø±Ú©Ø² Ø¨Ø± ØªØ­Ù„ÛŒÙ„ Ùˆ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)">Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ù„ÙˆÙ…)</option>
                        </select>
                    </div>
                    <div>
                        <label for="question-count" class="block text-sm font-medium mb-1">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª: <span id="question-count-label" class="font-bold text-blue-600">5</span></label>
                        <input type="range" id="question-count" min="1" max="10" value="5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                     <div class="space-y-3 pt-2">
                        <div class="flex items-center">
                            <input id="include-answers" type="checkbox" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="include-answers" class="mr-2 text-sm font-medium text-slate-700">Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡</label>
                        </div>
                        <div class="flex items-center">
                            <input id="include-hints" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="include-hints" class="mr-2 text-sm font-medium text-slate-700">Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÙØµÛŒÙ„ÛŒ</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Output -->
            <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h2 class="text-lg font-bold text-slate-800">Ø³ÙˆØ§Ù„Ø§Øª</h2>
                    <div id="output-actions" class="hidden space-x-2 space-x-reverse">
                        <button id="copy-btn" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†" class="p-2 rounded-md bg-slate-100 hover:bg-slate-200 transition-all">ğŸ“‹</button>
                        <button id="pdf-btn" title="Ú†Ø§Ù¾ / Ø°Ø®ÛŒØ±Ù‡ PDF" class="p-2 rounded-md bg-slate-100 hover:bg-slate-200 transition-all">ğŸ“„</button>
                    </div>
                </div>
                <!-- Section Toggle Controls -->
                <div id="section-toggles" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex flex-wrap items-center gap-4">
                        <span class="text-sm font-medium text-blue-800" id="sections-label">Show Sections:</span>
                        <label class="flex items-center space-x-2 space-x-reverse">
                            <input type="checkbox" id="toggle-questions" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm text-blue-700" id="toggle-questions-text">Questions</span>
                        </label>
                        <label id="toggle-answers-label" class="hidden flex items-center space-x-2 space-x-reverse">
                            <input type="checkbox" id="toggle-answers" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm text-blue-700" id="toggle-answers-text">Answer Key</span>
                        </label>
                        <label id="toggle-hints-label" class="hidden flex items-center space-x-2 space-x-reverse">
                            <input type="checkbox" id="toggle-hints" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm text-blue-700" id="toggle-hints-text">Hints</span>
                        </label>
                    </div>
                </div>
                <div id="output-container" class="prose prose-sm sm:prose-base max-w-none p-4 bg-slate-50 border rounded-md flex-1 overflow-y-auto">
                    <div id="placeholder" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0-0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <p class="text-center">Ø³ÙˆØ§Ù„Ø§Øª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
                    </div>
                    <div id="loader" class="hidden flex-col items-center justify-center h-full">
                        <div class="loader"></div>
                        <p class="mt-4 text-slate-500">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.</p>
                    </div>
                    <div id="results" class="hidden"></div>
                </div>
                 <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-5 rounded-full text-sm shadow-lg opacity-0 transition-opacity duration-300">
                    Ù¾ÛŒØ§Ù…
                </div>
            </div>
        </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', () => {
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        }

        const apiKeyInput = document.getElementById('apiKey');
        const textInput = document.getElementById('text-input');
        const fileInput = document.getElementById('file-input');
        const fileStatus = document.getElementById('file-status');
        const textTabBtn = document.getElementById('text-tab-btn');
        const fileTabBtn = document.getElementById('file-tab-btn');
        const textTabContent = document.getElementById('text-tab-content');
        const fileTabContent = document.getElementById('file-tab-content');
        const subjectSelect = document.getElementById('subject');
        const gradeSelect = document.getElementById('grade');
        const questionTypeSelect = document.getElementById('question-type');
        const difficultySelect = document.getElementById('difficulty');
        const questionCountSlider = document.getElementById('question-count');
        const questionCountLabel = document.getElementById('question-count-label');
        const includeAnswersCheckbox = document.getElementById('include-answers');
        const includeHintsCheckbox = document.getElementById('include-hints');
        const generateBtn = document.getElementById('generate-btn');
        const placeholder = document.getElementById('placeholder');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const outputActions = document.getElementById('output-actions');
        const copyBtn = document.getElementById('copy-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const toast = document.getElementById('toast');
        const toggleDarkMode = document.getElementById('toggle-dark-mode');
        const toggleLanguage = document.getElementById('toggle-language');
        
        // Section toggle elements
        const sectionToggles = document.getElementById('section-toggles');
        const toggleQuestionsCheckbox = document.getElementById('toggle-questions');
        const toggleAnswersCheckbox = document.getElementById('toggle-answers');
        const toggleHintsCheckbox = document.getElementById('toggle-hints');
        const toggleAnswersLabel = document.getElementById('toggle-answers-label');
        const toggleHintsLabel = document.getElementById('toggle-hints-label');
        
        // Language system
        let currentLanguage = 'fa'; // Default to Persian
        
        // Translation object
        const translations = {
            en: {
                title: "AI Exam Generator",
                apiKeyLabel: "ğŸ”‘ Gemini API Key",
                apiKeyLink: "Get key from here",
                apiKeyPlaceholder: "Enter your API key here...",
                sourceSection: "Question Source (Optional)",
                textTab: "Text",
                fileTab: "File",
                textPlaceholder: "To create questions from specific text, enter it here...",
                generateBtn: "ğŸš€ Generate Questions",
                settingsTitle: "Question Settings",
                subjectLabel: "Subject",
                gradeLabel: "Academic Level",
                questionTypeLabel: "Question Type",
                difficultyLabel: "Difficulty Level",
                questionCountLabel: "Number of Questions:",
                includeAnswersLabel: "Include Answer Key",
                includeHintsLabel: "Include Hints and Detailed Explanations",
                questionsTitle: "Questions",
                copyBtn: "Copy text",
                printBtn: "Print / Save PDF",
                sectionsLabel: "Show Sections:",
                questionsSection: "Questions",
                answersSection: "Answer Key",
                hintsSection: "Hints",
                placeholderText: "Generated questions will be displayed here.",
                loadingText: "Processing... Please wait.",
                // Select options
                selectPlaceholder: "Select...",
                subjects: {
                    "Ø¹Ù…ÙˆÙ…ÛŒ": "Select...",
                    "Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ": "English",
                    "Ø²ÛŒØ³Øª Ø´Ù†Ø§Ø³ÛŒ": "Biology",
                    "ÙÛŒØ²ÛŒÚ©": "Physics",
                    "Ø±ÛŒØ§Ø¶ÛŒ": "Mathematics",
                    "Ø´ÛŒÙ…ÛŒ": "Chemistry"
                },
                grades: {
                    "Ø¹Ù…ÙˆÙ…ÛŒ": "Select...",
                    "Ø¯ÙˆØ±Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "Elementary",
                    "Ù¾Ø§ÛŒÙ‡ Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "1st Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆÙ… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "2nd Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ø³ÙˆÙ… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "3rd Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ú†Ù‡Ø§Ø±Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "4th Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ù¾Ù†Ø¬Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "5th Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ø´Ø´Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ": "6th Grade",
                    "Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„": "Middle School",
                    "Ù¾Ø§ÛŒÙ‡ Ù‡ÙØªÙ…": "7th Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ù‡Ø´ØªÙ…": "8th Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ù†Ù‡Ù…": "9th Grade",
                    "Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…": "High School",
                    "Ù¾Ø§ÛŒÙ‡ Ø¯Ù‡Ù…": "10th Grade",
                    "Ù¾Ø§ÛŒÙ‡ ÛŒØ§Ø²Ø¯Ù‡Ù…": "11th Grade",
                    "Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…": "12th Grade",
                    "Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡": "University",
                    "Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ": "University Level"
                },
                questionTypes: {
                    "Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø­Ø±Ø§ÙÛŒ Ù…Ù†Ø·Ù‚ÛŒ": "Multiple Choice",
                    "ØµØ­ÛŒØ­/ØºÙ„Ø·": "True/False",
                    "ØªØ´Ø±ÛŒØ­ÛŒ Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø®": "Short Answer",
                    "ØªØ´Ø±ÛŒØ­ÛŒ Ø¨Ù„Ù†Ø¯ Ù¾Ø§Ø³Ø®": "Essay",
                    "Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ": "Fill in the Blank"
                },
                difficulties: {
                    "Ø¢Ø³Ø§Ù†": "Easy",
                    "Ù…ØªÙˆØ³Ø·": "Medium",
                    "Ø³Ø®Øª": "Hard",
                    "Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ù„ÙˆÙ… (ØªÙ…Ø±Ú©Ø² Ø¨Ø± ØªØ­Ù„ÛŒÙ„ Ùˆ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)": "Advanced (Bloom's Taxonomy)"
                },
                // Toast messages
                toastMessages: {
                    "Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ API Gemini Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.": "Please enter your Gemini API key.",
                    "Ù„Ø·ÙØ§Ù‹ ÛŒØ§ ÛŒÚ© Ù…Ù†Ø¨Ø¹ Ù…Ø­ØªÙˆØ§ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯ØŒ ÛŒØ§ Ø¯Ø±Ø³ Ùˆ Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.": "Please provide content source or specify subject and grade.",
                    "Ù…ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯!": "Text copied successfully!",
                    "Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†.": "Error copying text.",
                    "Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾...": "Preparing for print...",
                    "Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾ Ø¨Ø§Ø² Ø´Ø¯.": "Print window opened."
                },
                // File processing messages
                fileMessages: {
                    "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„:": "Processing file:",
                    "âœ… ÙØ§ÛŒÙ„": "âœ… File",
                    "Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯.": "read successfully.",
                    "Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù†": "Error reading",
                    "Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ PDF Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.": "PDF library not loaded.",
                    "ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ PDF ÛŒØ§ DOCX Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.": "File format not supported. Please upload PDF or DOCX."
                }
            },
            fa: {
                title: "ØªÙˆÙ„ÛŒØ¯ Ø¢Ø²Ù…ÙˆÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ",
                apiKeyLabel: "ğŸ”‘ Ú©Ù„ÛŒØ¯ API Gemini",
                apiKeyLink: "Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§",
                apiKeyPlaceholder: "Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...",
                sourceSection: "Ù…Ù†Ø¨Ø¹ Ø³ÙˆØ§Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
                textTab: "Ù…ØªÙ†",
                fileTab: "ÙØ§ÛŒÙ„",
                textPlaceholder: "Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­ Ø³ÙˆØ§Ù„ Ø§Ø² Ù…ØªÙ† Ø®Ø§ØµØŒ Ø¢Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...",
                generateBtn: "ğŸš€ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª",
                settingsTitle: "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÙˆØ§Ù„Ø§Øª",
                subjectLabel: "Ø¯Ø±Ø³",
                gradeLabel: "Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ",
                questionTypeLabel: "Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„",
                difficultyLabel: "Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ",
                questionCountLabel: "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª:",
                includeAnswersLabel: "Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡",
                includeHintsLabel: "Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÙØµÛŒÙ„ÛŒ",
                questionsTitle: "Ø³ÙˆØ§Ù„Ø§Øª",
                copyBtn: "Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†",
                printBtn: "Ú†Ø§Ù¾ / Ø°Ø®ÛŒØ±Ù‡ PDF",
                sectionsLabel: "Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´â€ŒÙ‡Ø§:",
                questionsSection: "Ø³ÙˆØ§Ù„Ø§Øª",
                answersSection: "Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡",
                hintsSection: "Ø±Ø§Ù‡Ù†Ù…Ø§",
                placeholderText: "Ø³ÙˆØ§Ù„Ø§Øª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.",
                loadingText: "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.",
                selectPlaceholder: "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯..."
            }
        };

        let fileContent = '';
        let rawGeneratedText = '';
        let parsedSections = { questions: '', answers: '', hints: '' };

        textTabBtn.addEventListener('click', () => switchTab('text'));
        fileTabBtn.addEventListener('click', () => switchTab('file'));
        questionCountSlider.addEventListener('input', () => {
            questionCountLabel.textContent = questionCountSlider.value;
        });
        fileInput.addEventListener('change', handleFile);
        generateBtn.addEventListener('click', handleGenerate);
        copyBtn.addEventListener('click', copyResults);
        pdfBtn.addEventListener('click', printToPDF);
        
        // Dark mode toggle functionality
        toggleDarkMode.addEventListener('change', (event) => {
            document.documentElement.classList.toggle('dark', event.target.checked);
            // Save preference to localStorage
            localStorage.setItem('darkMode', event.target.checked ? 'enabled' : 'disabled');
        });
        
        // Load dark mode preference on page load
        const darkModePreference = localStorage.getItem('darkMode');
        if (darkModePreference === 'enabled') {
            document.documentElement.classList.add('dark');
            toggleDarkMode.checked = true;
        }
        
        // Language switching functionality
        function updateUILanguage(lang) {
            const t = translations[lang];
            currentLanguage = lang;
            
            // Update page title and main header
            document.title = t.title;
            document.querySelector('h1').textContent = lang === 'fa' ? 'ğŸ“  ØªÙˆÙ„ÛŒØ¯ Ø¢Ø²Ù…ÙˆÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ' : `ğŸ“  ${t.title}`;
            
            // Update API key section
            document.querySelector('label[for="apiKey"]').textContent = t.apiKeyLabel;
            document.querySelector('a[href*="aistudio.google.com"]').textContent = t.apiKeyLink;
            apiKeyInput.placeholder = t.apiKeyPlaceholder;
            
            // Update source section
            document.querySelector('.lg\\:col-span-1 > div:first-child h2').textContent = t.sourceSection;
            textTabBtn.textContent = t.textTab;
            fileTabBtn.textContent = t.fileTab;
            textInput.placeholder = t.textPlaceholder;
            
            // Update generate button
            generateBtn.textContent = t.generateBtn;
            
            // Update settings panel
            const settingsTitle = document.querySelector('.control-panel h2');
            if (settingsTitle) settingsTitle.textContent = t.settingsTitle;
            
            // Update form labels
            const labels = document.querySelectorAll('.control-panel label');
            labels.forEach(label => {
                const forAttr = label.getAttribute('for');
                switch(forAttr) {
                    case 'subject':
                        label.textContent = t.subjectLabel;
                        break;
                    case 'grade':
                        label.textContent = t.gradeLabel;
                        break;
                    case 'question-type':
                        label.textContent = t.questionTypeLabel;
                        break;
                    case 'difficulty':
                        label.textContent = t.difficultyLabel;
                        break;
                    case 'question-count':
                        const countSpan = label.querySelector('#question-count-label');
                        if (countSpan) {
                            label.childNodes[0].textContent = t.questionCountLabel + ' ';
                        }
                        break;
                    case 'include-answers':
                        label.textContent = t.includeAnswersLabel;
                        break;
                    case 'include-hints':
                        label.textContent = t.includeHintsLabel;
                        break;
                }
            });
            
            // Update select options
            if (lang === 'en') {
                updateSelectOptions();
            } else {
                resetSelectOptionsToFarsi();
            }
            
            // Update output section
            document.querySelector('.lg\\:col-span-2 h2').textContent = t.questionsTitle;
            copyBtn.title = t.copyBtn;
            pdfBtn.title = t.printBtn;
            
            // Update section toggles by calling the correct function
            updateSectionToggleLabels();
            
            // Update placeholder and loading text
            const placeholderTextElem = document.querySelector('#placeholder p');
            if (placeholderTextElem) placeholderTextElem.textContent = t.placeholderText;
            
            const loaderTextElem = document.querySelector('#loader p');
            if (loaderTextElem) loaderTextElem.textContent = t.loadingText;
            
            // Re-render the displayed content with the new language's section headers
            updateDisplayedContent();
            
            // Save language preference
            localStorage.setItem('preferredLanguage', lang);
        }
        
        function updateSelectOptions() {
            const t = translations[currentLanguage];
            
            // Update subject select
            const subjectOptions = subjectSelect.querySelectorAll('option');
            subjectOptions.forEach(option => {
                if (t.subjects && t.subjects[option.value]) {
                    option.textContent = t.subjects[option.value];
                }
            });
            
            // Update grade select options and optgroups
            const gradeOptions = gradeSelect.querySelectorAll('option');
            const gradeOptgroups = gradeSelect.querySelectorAll('optgroup');
            
            gradeOptions.forEach(option => {
                if (t.grades && t.grades[option.value]) {
                    option.textContent = t.grades[option.value];
                }
            });
            
            gradeOptgroups.forEach(optgroup => {
                const persianLabel = optgroup.getAttribute('data-fa-label');
                if (t.grades && t.grades[persianLabel]) {
                    optgroup.label = t.grades[persianLabel];
                }
            });
            
            // Update question type options
            const questionTypeOptions = questionTypeSelect.querySelectorAll('option');
            questionTypeOptions.forEach(option => {
                if (t.questionTypes && t.questionTypes[option.value]) {
                    option.textContent = t.questionTypes[option.value];
                }
            });
            
            // Update difficulty options
            const difficultyOptions = difficultySelect.querySelectorAll('option');
            difficultyOptions.forEach(option => {
                if (t.difficulties && t.difficulties[option.value]) {
                    option.textContent = t.difficulties[option.value];
                }
            });
        }
        
        function resetSelectOptionsToFarsi() {
            // Use innerHTML to reset to the original Farsi state
            subjectSelect.innerHTML = `
                <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                <option value="Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ">Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</option>
                <option value="Ø²ÛŒØ³Øª Ø´Ù†Ø§Ø³ÛŒ">Ø²ÛŒØ³Øª Ø´Ù†Ø§Ø³ÛŒ</option>
                <option value="ÙÛŒØ²ÛŒÚ©">ÙÛŒØ²ÛŒÚ©</option>
                <option value="Ø±ÛŒØ§Ø¶ÛŒ">Ø±ÛŒØ§Ø¶ÛŒ</option>
                <option value="Ø´ÛŒÙ…ÛŒ">Ø´ÛŒÙ…ÛŒ</option>
            `;
            
            gradeSelect.innerHTML = `
                <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                <optgroup label="Ø¯ÙˆØ±Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ" data-fa-label="Ø¯ÙˆØ±Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">
                    <option value="Ù¾Ø§ÛŒÙ‡ Ø§ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø§ÙˆÙ„</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆÙ… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆÙ…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ø³ÙˆÙ… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø³ÙˆÙ…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ú†Ù‡Ø§Ø±Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ú†Ù‡Ø§Ø±Ù…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ù¾Ù†Ø¬Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ù¾Ù†Ø¬Ù…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ø´Ø´Ù… Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ">Ù¾Ø§ÛŒÙ‡ Ø´Ø´Ù…</option>
                </optgroup>
                <optgroup label="Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„" data-fa-label="Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø§ÙˆÙ„">
                    <option value="Ù¾Ø§ÛŒÙ‡ Ù‡ÙØªÙ…">Ù¾Ø§ÛŒÙ‡ Ù‡ÙØªÙ…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ù‡Ø´ØªÙ…">Ù¾Ø§ÛŒÙ‡ Ù‡Ø´ØªÙ…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ù†Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ Ù†Ù‡Ù…</option>
                </optgroup>
                <optgroup label="Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…" data-fa-label="Ø¯ÙˆØ±Ù‡ Ù…ØªÙˆØ³Ø·Ù‡ Ø¯ÙˆÙ…">
                    <option value="Ù¾Ø§ÛŒÙ‡ Ø¯Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ Ø¯Ù‡Ù…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ ÛŒØ§Ø²Ø¯Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ ÛŒØ§Ø²Ø¯Ù‡Ù…</option>
                    <option value="Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…">Ù¾Ø§ÛŒÙ‡ Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù…</option>
                </optgroup>
                 <optgroup label="Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡" data-fa-label="Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡">
                    <option value="Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ">Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ</option>
                </optgroup>
            `;
            
            questionTypeSelect.innerHTML = `
                <option value="Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø­Ø±Ø§ÙÛŒ Ù…Ù†Ø·Ù‚ÛŒ">Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</option>
                <option value="ØµØ­ÛŒØ­/ØºÙ„Ø·">ØµØ­ÛŒØ­/ØºÙ„Ø·</option>
                <option value="ØªØ´Ø±ÛŒØ­ÛŒ Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø®">ØªØ´Ø±ÛŒØ­ÛŒ (Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø®)</option>
                <option value="ØªØ´Ø±ÛŒØ­ÛŒ Ø¨Ù„Ù†Ø¯ Ù¾Ø§Ø³Ø®">ØªØ´Ø±ÛŒØ­ÛŒ (Ø¨Ù„Ù†Ø¯ Ù¾Ø§Ø³Ø®)</option>
                <option value="Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ">Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ</option>
            `;
            
            difficultySelect.innerHTML = `
                <option value="Ø¢Ø³Ø§Ù†">Ø¢Ø³Ø§Ù†</option>
                <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                <option value="Ø³Ø®Øª">Ø³Ø®Øª</option>
                <option value="Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ù„ÙˆÙ… (ØªÙ…Ø±Ú©Ø² Ø¨Ø± ØªØ­Ù„ÛŒÙ„ Ùˆ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)">Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ù„ÙˆÙ…)</option>
            `;
        }
        
        // Function to update section toggle labels specifically
        function updateSectionToggleLabels() {
            const t = translations[currentLanguage];
            
            // Update the main "Show Sections:" label using its ID
            const sectionsLabel = document.getElementById('sections-label');
            if (sectionsLabel) sectionsLabel.textContent = t.sectionsLabel;
            
            // Update individual toggle labels using their IDs
            const toggleQuestionsText = document.getElementById('toggle-questions-text');
            if (toggleQuestionsText) toggleQuestionsText.textContent = t.questionsSection;
            
            const toggleAnswersText = document.getElementById('toggle-answers-text');
            if (toggleAnswersText) toggleAnswersText.textContent = t.answersSection;
            
            const toggleHintsText = document.getElementById('toggle-hints-text');
            if (toggleHintsText) toggleHintsText.textContent = t.hintsSection;
        }
        
        // Language toggle event listener
        toggleLanguage.addEventListener('change', (event) => {
            const newLang = event.target.checked ? 'fa' : 'en';
            updateUILanguage(newLang);
        });
        
        // Load language preference on page load
        const savedLanguage = localStorage.getItem('preferredLanguage') || 'fa'; // Default to Persian
        toggleLanguage.checked = (savedLanguage === 'fa');
        updateUILanguage(savedLanguage);
        // Store the original Farsi labels for optgroups
        document.querySelectorAll('#grade optgroup').forEach(optgroup => {
            optgroup.setAttribute('data-fa-label', optgroup.label);
        });

        function switchTab(tab) {
            textTabContent.classList.toggle('hidden', tab !== 'text');
            fileTabContent.classList.toggle('hidden', tab !== 'file');
            textTabBtn.classList.toggle('active', tab === 'text');
            fileTabBtn.classList.toggle('active', tab === 'file');
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileStatus.textContent = `Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„: ${file.name}...`;
            fileContent = '';
            const reader = new FileReader();

            const processText = (text) => {
                fileContent = text;
                fileStatus.textContent = `âœ… ÙØ§ÛŒÙ„ ${file.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯.`;
            };

            const handleError = (err, type) => {
                fileStatus.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ${type}: ${err.message}`;
                fileContent = '';
            };

            if (file.type === "application/pdf") {
                reader.onload = (e) => {
                    if (!window.pdfjsLib) {
                        handleError({message: "Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ PDF Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."}, "PDF");
                        return;
                    }
                    const typedarray = new Uint8Array(e.target.result);
                    pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                        const pages = Array.from({ length: pdf.numPages }, (_, i) =>
                            pdf.getPage(i + 1).then(page => page.getTextContent())
                        );
                        return Promise.all(pages);
                    }).then(textContents => {
                        const text = textContents.map(tc => tc.items.map(item => item.str).join(' ')).join('\n');
                        processText(text);
                    }).catch(err => handleError(err, 'PDF'));
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.docx')) {
                reader.onload = (e) => {
                    mammoth.extractRawText({ arrayBuffer: e.target.result })
                        .then(result => processText(result.value))
                        .catch(err => handleError(err, 'DOCX'));
                };
                reader.readAsArrayBuffer(file);
            } else {
                fileStatus.textContent = "ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ PDF ÛŒØ§ DOCX Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.";
            }
        }

        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `fixed bottom-5 left-1/2 -translate-x-1/2 text-white py-2 px-5 rounded-full text-sm shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }
        
        function translateSectionHeaders(text) {
            // This function translates headers from Persian to the current language (English)
            const t = translations[currentLanguage];
            if (currentLanguage === 'en') {
                 return text
                    .replace(/\*\*Ø³ÙˆØ§Ù„Ø§Øª\*\*/g, `**${t.questionsSection}**`)
                    .replace(/\*\*Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡\*\*/g, `**${t.answersSection}**`)
                    .replace(/\*\*Ø±Ø§Ù‡Ù†Ù…Ø§\*\*/g, `**${t.hintsSection}**`);
            }
            return text; // Return original text if not English
        }
        
        function simpleMarkdownToHtml(text) {
             return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/^- (.*$)/gm, '<p>&bull; $1</p>') 
                .replace(/\n/g, '<br>');
        }

        async function handleGenerate() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showToast("Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ API Gemini Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.", true);
                return;
            }

            let currentContent = textTabBtn.classList.contains('active') ? textInput.value.trim() : fileContent;
            const subject = subjectSelect.value;
            const grade = gradeSelect.value;

            if (!currentContent && (subject === 'Ø¹Ù…ÙˆÙ…ÛŒ' || grade === 'Ø¹Ù…ÙˆÙ…ÛŒ')) {
                showToast("Ù„Ø·ÙØ§Ù‹ ÛŒØ§ ÛŒÚ© Ù…Ù†Ø¨Ø¹ Ù…Ø­ØªÙˆØ§ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯ØŒ ÛŒØ§ Ø¯Ø±Ø³ Ùˆ Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.", true);
                return;
            }

            placeholder.classList.add('hidden');
            results.innerHTML = '';
            results.classList.add('hidden');
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            outputActions.classList.add('hidden');
            sectionToggles.classList.add('hidden');
            
            const difficultyValue = difficultySelect.value;
            let modelName = 'gemini-1.5-flash-latest'; // A good default

            const prompt = constructPrompt(currentContent);
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.4,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 8192,
                        },
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                rawGeneratedText = data.candidates[0].content.parts[0].text;
                
                // Parse sections for toggling
                parseSections(rawGeneratedText);
                
                // Setup section toggles
                setupSectionToggles();
                
                // Initially display all content
                updateDisplayedContent();

                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([results]).catch((err) => console.error("MathJax typesetting error:", err));
                }
                
                results.classList.remove('hidden');
                outputActions.classList.remove('hidden');
                sectionToggles.classList.remove('hidden');

            } catch (error) {
                results.innerHTML = `<p class="text-red-500"><strong>Ø®Ø·Ø§:</strong> ${error.message}</p><p class="text-slate-500 mt-2">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ú©Ù„ÛŒØ¯ APIØŒ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ø¯Ù„ (${modelName}) Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯.</p>`;
                results.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function constructPrompt(content) {
            const subject = subjectSelect.value;
            const grade = gradeSelect.value;
            const questionType = questionTypeSelect.value;
            const difficulty = difficultySelect.value;
            const count = questionCountSlider.value;
            const includeAnswers = includeAnswersCheckbox.checked;
            const includeHints = includeHintsCheckbox.checked;

            let prompt = `Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù…ØªØ®ØµØµ Ø¯Ø± Ø·Ø±Ø§Ø­ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³ÛŒØ³ØªÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø§ÛŒØ±Ø§Ù† Ù‡Ø³ØªÛŒØ¯. ÙˆØ¸ÛŒÙÙ‡ Ø´Ù…Ø§ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø§Ø³Øª.`;
            
            if (content) {
                prompt += `\n\n**Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ù†Ø¨Ø¹:**\n---\n${content}\n---`;
            }

            prompt += `\n\n**ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¢Ø²Ù…ÙˆÙ†:**
- **Ø¯Ø±Ø³:** ${subject}
- **Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ:** ${grade}
- **ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª:** ${count} Ø¹Ø¯Ø¯
- **Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„Ø§Øª:** ${questionType}
- **Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ:** ${difficulty}

**Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ù„Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø±ÙˆØ¬ÛŒ (Ø­ØªÙ…Ø§Ù‹ Ø±Ø¹Ø§ÛŒØª Ø´ÙˆØ¯):**
1.  **Ù‚Ø§Ù†ÙˆÙ† Ø§Ù†Ø·Ø¨Ø§Ù‚:** ØªÙ…Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª Ø¨Ø§ÛŒØ¯ Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ **ÙˆØ²Ø§Ø±Øª Ø¢Ù…ÙˆØ²Ø´ Ùˆ Ù¾Ø±ÙˆØ±Ø´ Ø§ÛŒØ±Ø§Ù†** (Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§Ø·Ø¹ Ù…Ø¯Ø±Ø³Ù‡) Ùˆ **ÙˆØ²Ø§Ø±Øª Ø¹Ù„ÙˆÙ…ØŒ ØªØ­Ù‚ÛŒÙ‚Ø§Øª Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ Ø§ÛŒØ±Ø§Ù†** (Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§Ø·Ø¹ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ) Ø¨Ø§Ø´Ø¯.
2.  **Ù‚Ø§Ù†ÙˆÙ† Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø§Ù„Øµ:** Ú©Ù„ Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø³ÙˆØ§Ù„Ø§Øª (Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§) Ø¨Ø§Ø´Ø¯. Ù‡ÛŒÚ† Ù…ØªÙ† Ù…Ù‚Ø¯Ù…Ø§ØªÛŒØŒ Ø¬Ù…Ù„Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒØŒ ÛŒØ§ Ù‡Ø± Ù†ÙˆØ´ØªÙ‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø³Ø§Ø®ØªØ§Ø± Ø³ÙˆØ§Ù„Ø§Øª Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ù†.
3.  Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ ÙØ±Ù…Øª Markdown Ø³Ø§Ø¯Ù‡ Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.
4.  Ù‡Ø± Ø³ÙˆØ§Ù„ Ø±Ø§ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª **Ø¨ÙˆÙ„Ø¯** Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: **1.**).
5.  **Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ú†Ù†Ø¯Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒØŒ Ù‡Ø± Ú¯Ø²ÛŒÙ†Ù‡ (Ø§Ù„ÙØŒ Ø¨ØŒ Ø¬ØŒ Ø¯) Ø¨Ø§ÛŒØ¯ Ø¯Ø± ÛŒÚ© Ø®Ø· Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¨Ø§ ÛŒÚ© Ø®Ø· ØªÛŒØ±Ù‡ (-) Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¢Ù† Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯.** Ù…Ø«Ø§Ù„:
    - Ø§Ù„Ù) Ú¯Ø²ÛŒÙ†Ù‡ Ø§ÙˆÙ„
    - Ø¨) Ú¯Ø²ÛŒÙ†Ù‡ Ø¯ÙˆÙ…
6.  ØªÙ…Ø§Ù… Ø¹Ø¨Ø§Ø±Ø§Øª Ùˆ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ø±Ø§ **ÙÙ‚Ø· Ùˆ ÙÙ‚Ø·** Ø¨Ø§ Ø¹Ù„Ø§Ù…Øª Ø¯Ù„Ø§Ø± ($) Ø¨Ø±Ø§ÛŒ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ØªÙ† Ùˆ Ø¯Ùˆ Ø¹Ù„Ø§Ù…Øª Ø¯Ù„Ø§Ø± ($$) Ø¨Ø±Ø§ÛŒ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¯Ø± Ø¯Ùˆ Ø·Ø±Ù Ø§Ø­Ø§Ø·Ù‡ Ú©Ù†. Ù…Ø«Ø§Ù„: $E=mc^2$ ÛŒØ§ $$x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$$.
7.  **Ù…Ù‡Ù…ØªØ±ÛŒÙ† Ù‚Ø§Ù†ÙˆÙ†:** Ù‡Ø±Ú¯Ø²ØŒ ØªØ­Øª Ù‡ÛŒÚ† Ø´Ø±Ø§ÛŒØ·ÛŒØŒ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ LaTeX Ø±Ø§ Ø¯Ø§Ø®Ù„ Ø¨Ù„ÙˆÚ© Ú©Ø¯ (\`\`\`) Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡. Ø¢Ù†Ù‡Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¯Ø± Ù…ØªÙ† Ø¨Ø§Ø´Ù†Ø¯.
8.  **Ù‚Ø§Ù†ÙˆÙ† Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ:** Ù‡Ù…ÛŒØ´Ù‡ Ø¨ÛŒÙ† Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ Ùˆ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ ÛŒÚ© ÙØ§ØµÙ„Ù‡ (space) Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ØªØ§ Ø§Ø² Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ù‡Ù… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø´ÙˆØ¯. Ù…Ø«Ø§Ù„ ØºÙ„Ø·: \`Ø§Ú¯Ø±$x=2$Ø¨Ø§Ø´Ø¯\`. Ù…Ø«Ø§Ù„ ØµØ­ÛŒØ­: \`Ø§Ú¯Ø± $x=2$ Ø¨Ø§Ø´Ø¯\`.
`;

            // Add section ordering based on what's enabled
            let sectionNumber = 9;
            
            if (includeAnswers && includeHints) {
                prompt += `${sectionNumber}.  **Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡:** Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„ Ø®Ø±ÙˆØ¬ÛŒØŒ ÛŒÚ© Ø¨Ø®Ø´ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† "**Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡**" Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù† Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª ÙˆØ§Ø¶Ø­ Ù„ÛŒØ³Øª Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹: 1. Ø¨ØŒ 2. Ø§Ù„Ù).\n`;
                sectionNumber++;
                prompt += `${sectionNumber}.  **Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÙØµÛŒÙ„ÛŒ:** Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø®Ø´ Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ØŒ ÛŒÚ© Ø¨Ø®Ø´ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† "**Ø±Ø§Ù‡Ù†Ù…Ø§**" Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù† Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙˆØ§Ù„ ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ Ùˆ ØªÙØµÛŒÙ„ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯ Ú©Ù‡ Ø´Ø§Ù…Ù„ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø¨Ø§Ø´Ø¯:\n`;
                prompt += `    - **ØªØ­Ù„ÛŒÙ„ Ø³ÙˆØ§Ù„:** Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…ÙˆØ¶ÙˆØ¹ Ø³ÙˆØ§Ù„ Ùˆ Ù…ÙØ§Ù‡ÛŒÙ… Ù…Ø±ØªØ¨Ø· ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯\n`;
                prompt += `    - **Ø±ÙˆØ´ Ø­Ù„:** Ù…Ø±Ø­Ù„Ù‡ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù†Ø­ÙˆÙ‡ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø±Ø§ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯\n`;
                prompt += `    - **Ù†Ú©Ø§Øª Ù…Ù‡Ù…:** Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬ Ø±Ø§ Ø°Ú©Ø± Ú©Ù†ÛŒØ¯\n`;
                prompt += `    - **Ù…ÙØ§Ù‡ÛŒÙ… Ù…Ø±ØªØ¨Ø·:** Ù…ÙØ§Ù‡ÛŒÙ… Ùˆ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø±Ø§ ÛŒØ§Ø¯ Ø¢ÙˆØ±ÛŒ Ú©Ù†ÛŒØ¯\n`;
            } else if (includeAnswers) {
                prompt += `${sectionNumber}.  **Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡:** Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„ Ø®Ø±ÙˆØ¬ÛŒØŒ ÛŒÚ© Ø¨Ø®Ø´ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† "**Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡**" Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù† Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª ÙˆØ§Ø¶Ø­ Ù„ÛŒØ³Øª Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹: 1. Ø¨ØŒ 2. Ø§Ù„Ù).\n`;
            } else if (includeHints) {
                prompt += `${sectionNumber}.  **Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÙØµÛŒÙ„ÛŒ:** Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„ Ø®Ø±ÙˆØ¬ÛŒØŒ ÛŒÚ© Ø¨Ø®Ø´ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† "**Ø±Ø§Ù‡Ù†Ù…Ø§**" Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù† Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙˆØ§Ù„ ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ Ùˆ ØªÙØµÛŒÙ„ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯ Ú©Ù‡ Ø´Ø§Ù…Ù„ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø¨Ø§Ø´Ø¯:\n`;
                prompt += `    - **ØªØ­Ù„ÛŒÙ„ Ø³ÙˆØ§Ù„:** Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…ÙˆØ¶ÙˆØ¹ Ø³ÙˆØ§Ù„ Ùˆ Ù…ÙØ§Ù‡ÛŒÙ… Ù…Ø±ØªØ¨Ø· ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯\n`;
                prompt += `    - **Ø±ÙˆØ´ Ø­Ù„:** Ù…Ø±Ø­Ù„Ù‡ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù†Ø­ÙˆÙ‡ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø±Ø§ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯\n`;
                prompt += `    - **Ù†Ú©Ø§Øª Ù…Ù‡Ù…:** Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬ Ø±Ø§ Ø°Ú©Ø± Ú©Ù†ÛŒØ¯\n`;
                prompt += `    - **Ù…ÙØ§Ù‡ÛŒÙ… Ù…Ø±ØªØ¨Ø·:** Ù…ÙØ§Ù‡ÛŒÙ… Ùˆ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø±Ø§ ÛŒØ§Ø¯ Ø¢ÙˆØ±ÛŒ Ú©Ù†ÛŒØ¯\n`;
            } else {
                prompt += `${sectionNumber}.  ÙÙ‚Ø· Ø³ÙˆØ§Ù„Ø§Øª Ø±Ø§ Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ ÛŒØ§ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.\n`;
            }
            
            return prompt;
        }

        function parseSections(text) {
            // Reset parsed sections
            parsedSections = { questions: '', answers: '', hints: '' };
            
            // Look for answer key section
            const answerKeyMatch = text.match(/\*\*Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡\*\*([\s\S]*?)(?=\*\*Ø±Ø§Ù‡Ù†Ù…Ø§\*\*|$)/i);
            
            // Look for hints section
            const hintsMatch = text.match(/\*\*Ø±Ø§Ù‡Ù†Ù…Ø§\*\*([\s\S]*)$/i);
            
            // Extract questions section (everything before answer key or hints)
            let questionsEndIndex = text.length;
            if (answerKeyMatch) {
                questionsEndIndex = Math.min(questionsEndIndex, text.indexOf(answerKeyMatch[0]));
            }
            if (hintsMatch && !answerKeyMatch) { // only check for hints if no answer key was found before it
                questionsEndIndex = Math.min(questionsEndIndex, text.indexOf(hintsMatch[0]));
            }
            
            parsedSections.questions = text.substring(0, questionsEndIndex).trim();
            
            if (answerKeyMatch) {
                parsedSections.answers = '**Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡**' + answerKeyMatch[1].trim();
            }
            
            if (hintsMatch) {
                parsedSections.hints = '**Ø±Ø§Ù‡Ù†Ù…Ø§**' + hintsMatch[1].trim();
            }
        }
        
        function setupSectionToggles() {
            // Show/hide toggle labels based on what sections exist
            toggleAnswersLabel.classList.toggle('hidden', !parsedSections.answers);
            toggleHintsLabel.classList.toggle('hidden', !parsedSections.hints);
            
            // Update section toggle labels with current language
            updateSectionToggleLabels();
            
            // Add event listeners for toggle changes
            toggleQuestionsCheckbox.removeEventListener('change', updateDisplayedContent);
            toggleAnswersCheckbox.removeEventListener('change', updateDisplayedContent);
            toggleHintsCheckbox.removeEventListener('change', updateDisplayedContent);
            
            toggleQuestionsCheckbox.addEventListener('change', updateDisplayedContent);
            toggleAnswersCheckbox.addEventListener('change', updateDisplayedContent);
            toggleHintsCheckbox.addEventListener('change', updateDisplayedContent);
        }
        
        function updateDisplayedContent() {
            let displayContent = '';
            
            // Add questions section if enabled
            if (toggleQuestionsCheckbox.checked && parsedSections.questions) {
                displayContent += parsedSections.questions;
            }
            
            // Add answers section if enabled and exists
            if (toggleAnswersCheckbox.checked && parsedSections.answers) {
                if (displayContent) displayContent += '\n\n';
                displayContent += parsedSections.answers;
            }
            
            // Add hints section if enabled and exists
            if (toggleHintsCheckbox.checked && parsedSections.hints) {
                if (displayContent) displayContent += '\n\n';
                displayContent += parsedSections.hints;
            }
            
            // Translate section headers if language is English
            let finalContent = translateSectionHeaders(displayContent);
            
            // Update the displayed content
            results.innerHTML = simpleMarkdownToHtml(finalContent);
            
            // Re-render MathJax if available
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([results]).catch((err) => console.error("MathJax typesetting error:", err));
            }
        }
        
        function copyResults() {
            // Get the currently displayed content based on toggle states
            let contentToCopy = '';
            
            if (toggleQuestionsCheckbox.checked && parsedSections.questions) {
                contentToCopy += parsedSections.questions;
            }
            
            if (toggleAnswersCheckbox.checked && parsedSections.answers) {
                if (contentToCopy) contentToCopy += '\n\n';
                contentToCopy += parsedSections.answers;
            }
            
            if (toggleHintsCheckbox.checked && parsedSections.hints) {
                if (contentToCopy) contentToCopy += '\n\n';
                contentToCopy += parsedSections.hints;
            }
            
            // Fallback to raw text if no sections are parsed
            const textToCopy = contentToCopy || rawGeneratedText;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast("Ù…ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯!");
            }).catch(err => {
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†.", true);
            });
        }

        async function printToPDF() {
            showToast("Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾...");
            
            // Wait for MathJax to finish rendering before printing
            if (window.MathJax && window.MathJax.typesetPromise) {
                await MathJax.typesetPromise([results]);
            }
            
            window.print();
            showToast("Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾ Ø¨Ø§Ø² Ø´Ø¯.");
        }

    });
    </script>
</body>
</html>
